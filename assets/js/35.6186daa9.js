(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{522:function(s,e,a){"use strict";a.r(e);var n=a(4),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("MySQL 主从复制的方式有多种，本文主要演示基于基于日志（binlog）的主从复制方式。\n")]),s._v(" "),a("h2",{attrs:{id:"介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[s._v("#")]),s._v(" 介绍")]),s._v(" "),a("p",[s._v("MySQL 主从复制（也称 A/B 复制） 的原理")]),s._v(" "),a("p",[s._v("Master将数据改变记录到二进制日志(binary log)中，也就是配置文件log-bin指定的文件，\n这些记录叫做二进制日志事件(binary log events)；")]),s._v(" "),a("p",[s._v("Slave 通过 I/O 线程读取 Master 中的 binary log events 并写入到它的中继日志(relay log)；")]),s._v(" "),a("p",[s._v("Slave 重做中继日志中的事件， 把中继日志中的事件信息一条一条的在本地执行一次，完\n成数据在本地的存储， 从而实现将改变反映到它自己的数据(数据重放)。")]),s._v(" "),a("h2",{attrs:{id:"主从配置需要注意的点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主从配置需要注意的点"}},[s._v("#")]),s._v(" 主从配置需要注意的点")]),s._v(" "),a("p",[s._v("主从服务器操作系统版本和位数一致；")]),s._v(" "),a("p",[s._v("Master 和 Slave 数据库的版本要一致；")]),s._v(" "),a("p",[s._v("Master 和 Slave 数据库中的数据要一致；")]),s._v(" "),a("p",[s._v("Master 开启二进制日志， Master 和 Slave 的 server_id 在局域网内必须唯一；")]),s._v(" "),a("h2",{attrs:{id:"主从配置的简要步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主从配置的简要步骤"}},[s._v("#")]),s._v(" 主从配置的简要步骤")]),s._v(" "),a("h3",{attrs:{id:"master-上的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#master-上的配置"}},[s._v("#")]),s._v(" Master 上的配置")]),s._v(" "),a("p",[s._v("安装数据库；\n修改数据库配置文件， 指明 server_id， 开启二进制日志(log-bin)；\n启动数据库， 查看当前是哪个日志， position 号是多少；\n登录数据库， 授权数据复制用户（IP 地址为从机 IP 地址， 如果是双向主从， 这里的还需要授权本机的 IP 地址， 此时自己的 IP 地址就是从 IP 地址)；\n备份数据库（记得加锁和解锁）；\n传送备份数据到 Slave 上；\n启动数据库；\n以下步骤， 为单向主从搭建成功， 想搭建双向主从需要的步骤：")]),s._v(" "),a("p",[s._v("登录数据库， 指定 Master 的地址、 用户、 密码等信息（此步仅双向主从时需要）；\n开启同步， 查看状态；\nSlave 上的配置")]),s._v(" "),a("p",[s._v("安装数据库；\n修改数据库配置文件， 指明 server_id（如果是搭建双向主从的话， 也要开启二进制\n日志 log-bin）；\n启动数据库， 还原备份；\n查看当前是哪个日志， position 号是多少（单向主从此步不需要， 双向主从需要）；\n指定 Master 的地址、 用户、 密码等信息；\n开启同步， 查看状态。\n1、主节（Master）点配置")]),s._v(" "),a("p",[s._v("修改 Master 的配置文件/etc/my.cnf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vi /etc/my.cnf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在my.cnf文件中加入如下配置内容")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[mysqld]\nlog-bin=mysql-bin\nserver-id=1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("2、从节点（Slave）配置")]),s._v(" "),a("p",[s._v("修改 Slave 的配置文件/etc/my.cnf")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vi /etc/my.cnf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在my.cnf文件中加入如下配置内容")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[mysqld]\nserver-id=2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("3、创建用于复制操作的用户")]),s._v(" "),a("p",[s._v("在主节点创建一个用户repl，用于从节点链接主节点时使用。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> CREATE USER 'repl'@'192.168.199.198' IDENTIFIED WITH mysql_native_password BY 'Ron_master_1';\nmysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.199.198';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("刷新授权表信息")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> flush privileges;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4、获取主节点当前binary log文件名和位置（position）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> SHOW MASTER STATUS;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("5、在从（Slave）节点上设置主节点参数")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> CHANGE MASTER TO\nMASTER_HOST='192.168.199.149',\nMASTER_USER='repl',\nMASTER_PASSWORD='Ron_master_1',\nMASTER_LOG_FILE='binlog.000006',\nMASTER_LOG_POS=856;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("6、查看主从同步状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> show slave status\\G;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("7、开启主从同步")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> start slave;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("8、再查看主从同步状态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> show slave status\\G;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看状态时，可能会出现I/O任务启动失败的情况，即如下错误:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server ids; these ids must be different for replication to work (or the –replicate-same-server-id option must be used on slave but this does not always make sense; please check the manual before using it).\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这是因为在MySQL主从结构中，从机上的server_id和主机上的server_id不能相同，我们可以看一下主机上的server_id和从机上的server_id是否相同。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> show variables like 'server_id'; \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("主机：")]),s._v(" "),a("p",[s._v("从机：")]),s._v(" "),a("p",[s._v("这里我们把从机的server_id改成2")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> set global server_id=2; #此处的数值和my.cnf里设置的一样就行 \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("9、重新开启同步并查看装态")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> start slave;\nmysql> show slave status\\G;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("开启主从之后，如果状态如上图所示，那么说明主从信息就已经配置好了，接下来我们测试一下在主机上创建一个数据库，然后在从机上是否能够同步创建。")]),s._v(" "),a("p",[s._v("首先看一下我们主机和从机除了MySQL本身自带的数据库之前目前是没有任何数据的。")]),s._v(" "),a("p",[s._v("2.5 主库添加log-bin-index 参数后，从库报这个错误：Got fatal error 1236 from master when reading data from binary log: 'Could not find first log file name in binary log index file'\nGot fatal error 1236 from master when reading data from binary log: 'could not find next log'")]),s._v(" "),a("p",[s._v("【如何解决】")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("stop slave;\nreset slave;\nstart slave;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);